@(idUrlBuilder: services.IdentityUrlBuilder,
  idRequest: services.IdentityRequest,
  user: com.gu.identity.model.User,
  privacyForm: Form[form.PrivacyFormData])(implicit request: RequestHeader, messages: play.api.i18n.Messages)

@import views.html.fragments.form.checkboxField
@import form.IdFormHelpers._
@import helper._
@import views.html.fragments.registrationFooter
@import org.joda.time.DateTime
@import idapiclient.parser.JodaJsonSerializer

@*
    WARNING!!

    Make sure you are testing bounds

    [IndexOutOfBoundsException: 0]
    <input type="hidden" name=@(consent.name + ".consentIdentifier") value=@(user.consents.toList(consentIndex).consentIdentifier)>
*@

@getConsentText(index: Int) = {
    @if(user.consents.toList.isEmpty) {
        "Unknown consent text"
    } else {
        @com.gu.identity.model.ConsentData.getText(
            user.consents.toList(index).consentIdentifier,
            user.consents.toList(index).consentIdentifierVersion
        )
    }
}

@getCurrentTime = {
    @JodaJsonSerializer.dateTimeFormatISO8601.print(new DateTime)
}

@v2consentCheckboxes = {
  @helper.repeatWithIndex(privacyForm("consents"), min=1) {(consent, consentIndex) =>
      <input type="hidden" name=@(consent.name + ".actor") value='user'>
      <input type="hidden" name=@(consent.name + ".consentIdentifier") value=@(user.consents.toList(consentIndex).consentIdentifier)>
      <input type="hidden" name=@(consent.name + ".consentIdentifierVersion") value=@(user.consents.toList(consentIndex).consentIdentifierVersion)>
      <input type="hidden" name=@(consent.name + ".timestamp") value=@getCurrentTime>
      <input type="hidden" name=@(consent.name + ".privacyPolicy") value=@(user.consents.toList(consentIndex).privacyPolicy)>

      @checkboxField(
          Checkbox(
              privacyForm(consent.name + ".hasConsented"),
              '_label -> getConsentText(consentIndex)
          )
      )(nonInputFields, messages)
  }
}

@v1consentCheckboxes = {
    @checkboxField(Checkbox(
        privacyForm("receiveGnmMarketing"),
        '_label -> "Receive email from Guardian News and Media Ltd."))(nonInputFields, messages)

    @checkboxField(Checkbox(
        privacyForm("receive3rdPartyMarketing"),
        '_label -> "Receive email from other organisations"))(nonInputFields, messages)
}

@v1profilingConsetCheckbox = {
    @checkboxField(Checkbox(
        privacyForm("allowThirdPartyProfiling"),
        '_label -> "Allow matching with third party data")
    )(nonInputFields, messages)
}

@v2consentCheckboxesOnboarding = {

    @* FIRST PARTY *@

    <input type="hidden" name="consents[0].actor" value='user'>
    <input type="hidden" name="consents[0].consentIdentifier" value="firstParty">
    <input type="hidden" name="consents[0].consentIdentifierVersion" value="0">
    <input type="hidden" name="consents[0].timestamp" value=@getCurrentTime>
    <input type="hidden" name="consents[0].privacyPolicy" value=@com.gu.identity.model.ConsentData.privacyPolicyVersion>

    @checkboxField(
        Checkbox(
            privacyForm("consents[0].hasConsented"),
            '_label -> com.gu.identity.model.ConsentData.currentConsents("firstParty")
        )
    )(nonInputFields, messages)

    @* THIRD PARTY *@

    <input type="hidden" name="consents[1].actor" value='user'>
    <input type="hidden" name="consents[1].consentIdentifier" value="thirdParty">
    <input type="hidden" name="consents[1].consentIdentifierVersion" value="0">
    <input type="hidden" name="consents[1].timestamp" value=@getCurrentTime>
    <input type="hidden" name="consents[1].privacyPolicy" value=@com.gu.identity.model.ConsentData.privacyPolicyVersion>

    @checkboxField(
        Checkbox(
            privacyForm("consents[1].hasConsented"),
            '_label -> com.gu.identity.model.ConsentData.currentConsents("thirdParty")
        )
    )(nonInputFields, messages)
}


@v2consentProfilingCheckboxOnboarding  = {

    @* PROFILING *@

    <input type="hidden" name="consents[2].actor" value='user'>
    <input type="hidden" name="consents[2].consentIdentifier" value="thirdPartyProfiling">
    <input type="hidden" name="consents[2].consentIdentifierVersion" value="0">
    <input type="hidden" name="consents[2].timestamp" value=@getCurrentTime>
    <input type="hidden" name="consents[2].privacyPolicy" value=@com.gu.identity.model.ConsentData.privacyPolicyVersion>

    @checkboxField(
        Checkbox(
            privacyForm("consents[2].hasConsented"),
            '_label -> com.gu.identity.model.ConsentData.currentConsents("thirdPartyProfiling")
        )
    )(nonInputFields, messages)
}


@noV2Consents = { @user.consents.toList.isEmpty }

<form class="form js-public-profile-form" novalidate action="@idUrlBuilder.buildUrl("/privacy/edit", idRequest)" role="main" method="post">
    @views.html.helper.CSRF.formField

    @* Make this beautiful *@
    @* This also displays globalErrors *@
    @if(privacyForm.hasErrors) {
        <div class="form__error">
          Error processing the form. Your changes have not been saved:
          <p>@privacyForm.errors.map(formError => (formError.key, formError.message)).mkString(", ")</p>
        </div>
    }

    <fieldset class="fieldset">
        <div class="fieldset__heading">
            <h2 class="form__heading">Guardian & Observer newsletters</h2>
        </div>

        <div class="fieldset__fields">
            <ul class="u-unstyled">
                <li class="form-field">
                    <label class="label">Click <a href=@idUrlBuilder.buildUrl("/email-prefs")>here</a> to manage your email subscriptions.</label>
                </li>
            </ul>
        </div>
    </fieldset>
    <fieldset class="fieldset">

        <div class="fieldset__heading">
            <h2 class="form__heading">Marketing</h2>
        </div>

        <div class="fieldset__fields">
            <ul class="u-unstyled">
                <li class="form-field">
                    <label class="label">Would you like to receive information from the Guardian and their partners?</label>
                    <div class="form-field__note">The Guardian and their partners would like to occasionally send you information about their products, services and events.</div>

                    <div class="form-fields-group">
                        @v2consentCheckboxesOnboarding
                    </div>
                </li>
            </ul>
        </div>
    </fieldset>
    <fieldset class="fieldset">
        <div class="fieldset__heading">
            <h2 class="form__heading">Profiling</h2>
        </div>
        <div class="fieldset__fields">
            <ul class="u-unstyled">
                <li class="form-field">
                    <label class="label">In addition to the data that you provide to us, we may also match profiling data from third parties with your registration details.</label>

                    <div class="form-fields-group">
                        @v2consentProfilingCheckboxOnboarding
                    </div>
                </li>
            </ul>
        </div>
     </fieldset>
    <fieldset class="fieldset">
        <div class="fieldset__heading"></div>
        <div class="fieldset__fields">
            <ul class="u-unstyled">
                <li>
                    <button type="submit" class="submit-input" data-link-name="Save privacy preferences">Save changes</button>
                </li>
            </ul>
        </div>

    </fieldset>
</form>

@registrationFooter(idRequest, idUrlBuilder)
