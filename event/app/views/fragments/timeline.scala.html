@(story: Story)

@standfirst(s: String) = {
    @withJsoup(BulletCleaner(StripHtmlTags(s)))()
}

@article(a: model.Article) = {
    <li class="event-articles--item">
        @fragments.relativeDate(a.webPublicationDate, false, false)
        <p class="type-7">
            <a href="@a.url">
                @a.standfirst.map { s =>
                    @standfirst(s)
                }.getOrElse(a.headline)
            </a>
        </p>
    </li>
}

@gallery(g: model.Gallery) = {
    <li class="event-articles--item event-articles--media">
        @fragments.relativeDate(g.webPublicationDate, false, false)
        <p class="type-7">
            <a href="@g.url">
            @g.standfirst.map { s =>
                @standfirst(s)
            }.getOrElse(g.headline)
            </a>
        </p>
        @g.images.take(4).zipWithRowInfo.map{ case(image, info) =>
            <a href="@g.url?index=@info.rowNum"><img src="@image.url" alt="@Html(image.caption.getOrElse(""))" /></a>
        }
    </li>
}

@video(v: model.Video) = {
<li class="event-articles--item event-articles--media">
    @fragments.relativeDate(v.webPublicationDate, false, false)
    <p class="type-7">
        <a href="v.url">
        @v.standfirst.map { s =>
            @standfirst(s)
        }.getOrElse(v.headline)
        </a>
    </p>
    <div class="player">
        <video controls="controls" poster="@v.imageOfWidth(640).map{ image => @image.url }.getOrElse("")">
        @v.encodings.map{ encoding =>
        <source src="@encoding.url" />
        }
        Your browser does not support the video tag.
        </video>
    </div>
</li>
}

@eventList(events: Seq[Event], isPanel: Boolean) = {
    <ul class="unstyled @if(isPanel){ panel}">
        @events.map { event =>
            <li class="trail event-block" data-link-name="trail">
                @defining(event.content.take(1).map(_.isLive).headOption.getOrElse(false)){ isLive =>
                    @fragments.relativeDate(event.startDate, isLive=isLive, isFront=true)
                }
                <div class="date-line">
                    <h3 class="type-5">@event.title</h3>
                </div>

                <div class="event-children">
                    @if(event.hasExplainer) { <p class="event-summary">@event.explainer.get</p> }

                    @if(event.hasContent) {
                    <ul class="unstyled event-articles">
                        @event.content.map{
                            case a: Article => { @article(a) }
                            case g: Gallery => { @gallery(g) }
                            case v: Video   => { @video(v) }
                        }
                    </ul>
                </div>
                }
            </li>
        }
    </ul>
}

<div id="js-timeline" class="timeline box-indent expandable"
     data-count="@{story.events.size - 3}" data-link-name="Event timeline">
    @eventList(story.events.take(3), false)
    @eventList(story.events.drop(3), true)
</div>