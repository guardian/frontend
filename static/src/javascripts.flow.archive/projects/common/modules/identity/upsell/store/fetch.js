/**
 * DO NOT EDIT THIS FILE
 *
 * It is not used to to build anything.
 *
 * It's just a record of the old flow types.
 *
 * Use it as a guide when converting
 * - static/src/javascripts/projects/common/modules/identity/upsell/store/fetch.js
 * to .ts, then delete it.
 */

// @flow
import {
    getAllConsents,
    getAllNewsletters,
    getSubscribedNewsletters,
    getUserFromApi,
} from 'common/modules/identity/api';
import { UserConsentWithState, EmailConsentWithState } from './types';

const fetchSubscribedConsents = (): Promise<string[]> =>
    new Promise(accept => {
        getUserFromApi(user => {
            if (user && user.consents) {
                accept(
                    user.consents
                        .filter(consent => consent.consented === true)
                        .map(consent => consent.id)
                );
            } else {
                accept([]);
            }
        });
    });

const fetchUserConsents = Promise.all([
    fetchSubscribedConsents(),
    getAllConsents(),
]).then(([acceptedConsents, allConsents]) =>
    allConsents.map(
        consent =>
            new UserConsentWithState(
                consent,
                acceptedConsents.includes(consent.id)
            )
    )
);

const fetchNewsletters = Promise.all([
    getAllNewsletters(),
    getSubscribedNewsletters(),
]).then(([allNewsletters, subscribedNewsletters]) =>
    allNewsletters.map(
        nl =>
            new EmailConsentWithState(
                nl,
                subscribedNewsletters.includes(nl.listId.toString())
            )
    )
);

export { fetchUserConsents, fetchNewsletters };
