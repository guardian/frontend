@(page: model.Page)(body: Html)(implicit request: RequestHeader, context: model.ApplicationContext)

@import conf.switches.Switches._
@import common.InlineJs
@import templates.inlineJS.blocking.js._
@import templates.inlineJS.nonBlocking.js.emailIframeTracking
@import play.api.Mode.Dev
@import conf.Static
@import views.support.RenderClasses

<!doctype html>
<html>
<head>
    @if(FontSwitch.isSwitchedOn) {
        @fragments.fontFaces()
    }

    @if(context.environment.mode == Dev || !InlineCriticalCss.isSwitchedOn) {
        <link rel="stylesheet" type="text/css" href="@Static("stylesheets/head.email-signup.css")" />
    } else {
        <style class="js-loggable">
        @Html(common.Assets.css.head(Some("email-signup")))
        </style>
    }

    <script>
        @Html(config(page).body)
        @InlineJs(emailIframeTracking().body, "emailIframeTracking.js")
    </script>

</head>
    <body>
        @body
    </body>
    <script src="https://interactive.guim.co.uk/libs/iframe-messenger/iframeMessenger.js"></script>
    <script>
        iframeMessenger.enableAutoResize();
    </script>
    @if(EmailSignupRecaptcha.isSwitchedOn) {
        <script>
            (() => {
                var height = parseInt(document.body.offsetHeight, 10);
                var styles = document.defaultView.getComputedStyle(document.body);
                height += parseInt(styles.getPropertyValue('margin-bottom'), 10);
                height += parseInt(styles.getPropertyValue('margin-top'), 10);
                sendResizeMessage(height)
            })()
            const submitButton = document.querySelector('.email-sub__submit-button')
            setupSubmitListener()

            const resizeToOriginalHeight = (() => {
                const originalHeight = document.body.clientHeight
                return () => sendResizeMessage(`${originalHeight}px`)
            })()

            function sendResizeMessage(height) {
                window.parent.postMessage(JSON.stringify({
                    type: 'set-height',
                    value: height,
                    src: window.location.href
                }), '*')
            }

            function resizeToFitCaptcha() {
                sendResizeMessage('500px')
            }

            function setupSubmitListener() {
                submitButton.addEventListener('click', (e) => onSubmit(e))
            }

            function onSubmit(e) {
                e.preventDefault()
                (function(d, script) {
                    script = d.createElement('script');
                    script.type = 'text/javascript';
                    script.async = true;
                    script.defer = true
                    script.src = 'https://www.google.com/recaptcha/api.js?onload=onRecaptchaScriptLoaded&render=explicit';
                    d.getElementsByTagName('head')[0].appendChild(script);
                }(document));
            }

            function onRecaptchaScriptLoaded() {
                resizeToFitCaptcha()
                grecaptcha.render('grecaptcha_container', {
                    sitekey: window.guardian.config.page.googleRecaptchaSiteKey,
                    callback: onCaptchaCompleted,
                    'error-callback': onCaptchaError,
                    'expired-callback': onCaptchaExpired,
                    size: 'invisible'
                })
                grecaptcha.execute()
            }

            function onCaptchaCompleted(token) {
                resizeToOriginalHeight()
                document.querySelector('.email-sub__form').submit()
            }

            function onCaptchaError() {
                resizeToOriginalHeight()
            }

            function onCaptchaExpired() {
                resizeToOriginalHeight()
            }
        </script>
    }
</html>
