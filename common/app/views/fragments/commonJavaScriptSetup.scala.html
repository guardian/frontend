@(item: MetaData, bootstrapJsModule: String, switches: Seq[com.gu.management.Switchable])(implicit request: RequestHeader)

@import CommonSwitches.FontSwitch

<script id="gu">
    // we want this to happen ASAP to avoid FOUC
    document.documentElement.className = document.documentElement.className.replace(/\bjs-off\b/g, '') + ' js-on ';

    var guardian = {
            isModernBrowser: ('querySelector' in document && 'addEventListener' in window && 'localStorage' in window)
            }, 
            curl = {
                baseUrl: '@{Configuration.static.path}javascripts',
                apiName: 'require',
                paths: {
                    omniture: '@Static("javascripts/vendor/omniture.js")',
                    homescreen: '@Static("javascripts/vendor/add2home.js")', // Mofified version. Do not upgrade.
                    bean: '@Static("javascripts/components/bean/bean.js")',
                    bonzo: '@Static("javascripts/components/bonzo/src/bonzo.js")',
                    domReady: '@Static("javascripts/components/domready/ready.js")',
                    EventEmitter: '@Static("javascripts/components/eventEmitter/EventEmitter.js")',
                    qwery: '@Static("javascripts/components/qwery/mobile/qwery-mobile.js")',
                    reqwest: '@Static("javascripts/components/reqwest/src/reqwest.js")',
                    domwrite: '@Static("javascripts/components/dom-write/dom-write.js")',
                    swipe: '@Static("javascripts/components/swipe/swipe.js")'
                }
            };

    (function loadFontsFromStorage(prefs, key) {

        var showFonts = false;
        @if(FontSwitch.isSwitchedOn) {
            showFonts = true;
        }
        if (localStorage['gu.prefs.switch.font-family'] === true) {
            showFonts = true;
        } else
        if (localStorage['gu.prefs.switch.font-family'] === false) {
            showFonts = false;
        }

        if (showFonts) {
            var start = (new Date().getTime());
            var styleNodes = document.querySelectorAll('[data-cache-name]');
            for (var i = 0, j = styleNodes.length; i<j; ++i) {
                var style = styleNodes[i],
                    nameAndCacheKey = style.getAttribute('data-cache-file-woff').match(/fonts\/(.*)\.woff(:?\.(.*))?\.js$/),
                    cachedCss = localStorage.getItem('gu.fonts.' + nameAndCacheKey[1] + '.' + nameAndCacheKey[2]);
                if (cachedCss) {
                    style.innerHTML = cachedCss;
                    style.setAttribute('data-cache-full', 'true');
                    document.querySelector('html').className += ' font-' + name + '-loaded';
                }
            }
            var fontTime = (new Date().getTime()) - start;
            if (fontTime > 50) {
                var img = document.createElement("img");
                img.style = "display: none";
                img.src = "//beacon." + window.location.hostname +  "/px.gif?fonts/&fonttime=" + fontTime;
                document.getElementsByTagName("head")[0].appendChild(img);
            }
        }
    })();

    (function(isModern) {

        if (!isModern) { return false; }

        guardian.config = {
            @item match {
                case content: model.Content => {'webPublicationDate' : new Date(@content.webPublicationDate.getMillis),}
                case other => {@None}
            }
            page: {
                @{Html(item.metaData.map{ data => MetadataJson(data) }.mkString(","))},

                @{Html((Configuration.javascript.config ++ Configuration.javascript.pageData).map{ case (key, value) =>
                    s"'${JavaScriptVariableName(key.split('.').last)}':'${value}'"}.mkString(",")
                )},
                'edition': '@Site(request).edition',
                'ajaxUrl': 'http://@Site(request).ajaxHost',
                isDev: @play.Play.isDev()
            },
            switches : { @{Html(switches.map{ switch =>
                    s"'${JavaScriptVariableName(switch.name)}':${switch.isSwitchedOn}"
                }.mkString(","))}
            }
        };
        
        var curlScript = document.createElement('script');
        curlScript.src = '@Static("javascripts/components/curl/dist/curl-with-js-and-domReady/curl.js")';
        document.getElementsByTagName("head")[0].appendChild(curlScript);

        var appScript = document.createElement('script');
        appScript.src = '@Static("javascripts/bootstraps/app.js")';
        document.getElementsByTagName("head")[0].appendChild(appScript);

        var goScript = document.createElement('script');
        goScript.async = 'async';
        goScript.src = '@Static("javascripts/bootstraps/go.js")';
        document.getElementsByTagName("head")[0].appendChild(goScript);
    
    })(guardian.isModernBrowser);

</script>
