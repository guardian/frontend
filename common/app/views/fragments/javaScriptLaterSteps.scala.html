@(item: model.MetaData, curlPaths: Map[String, String] = Map())(implicit request: RequestHeader)
@import conf.Switches._
@import conf.Static
@import conf.Configuration

@* Scripts that should be executed after CSS is loaded *@

<script>

    var curl = {
        baseUrl: '@{Configuration.assets.path}javascripts',
        apiName: 'require',
        paths: {
            @curlPaths.map { case (module, path) =>
                '@module': '@Static(path)',
            }
            core:                      '@Static("javascripts/core.js")',
            facebook:                  '//connect.facebook.net/en_US/all.js',
            foresee:                   'vendor/foresee/20141107/foresee-trigger.js',
            googletag:                 '@{Configuration.javascript.config("googletagJsUrl")}',
            'ophan/ng':                '@{Configuration.javascript.config("ophanJsUrl")}',
            stripe:                    '@Static("javascripts/vendor/stripe/stripe.min.js")',
            text:                       'text', // noop
            zxcvbn:                    '@Static("javascripts/components/zxcvbn/zxcvbn.js")',
            'bootstraps/app':          '@Static("javascripts/bootstraps/app.js")',
            'bootstraps/commercial':   '@Static("javascripts/bootstraps/commercial.js")',
            'bootstraps/creatives':    '@Static("javascripts/bootstraps/creatives.js")',
            'bootstraps/crosswords':   '@Static("javascripts/bootstraps/crosswords.js")',
            'bootstraps/dev':          '@Static("javascripts/bootstraps/dev.js")',
            'bootstraps/facia':        '@Static("javascripts/bootstraps/facia.js")',
            @if(Configuration.environment.isPreview) {
                'bootstraps/preview':  '@Static("javascripts/bootstraps/preview.js")',
            }
            'bootstraps/video-player': '@Static("javascripts/bootstraps/video-player.js")'
        }
    };

    (function(isModern) {

        if (!isModern) { return false; }

        // duplicated in detect.js
        var shouldUseHintedFonts = function shouldUseHintedFonts() {
            var windowsNT = /Windows NT (\d\.\d+)/.exec(navigator.userAgent);

            if (windowsNT) {
                var version = parseFloat(windowsNT[1], 10);
                // windows XP and newer && windows 7 and older
                return version >= 5.1 && version <= 6.1;
            } else {
                return false;
            }
        }();

        function loadFontsAsynchronously() {
            @if(FontSwitch.isSwitchedOff) {
                return;
            }

            var scripts    = document.getElementsByTagName('script'),
                thisScript = scripts[scripts.length - 1],
                fonts      = document.createElement('link');

            fonts.rel       = 'stylesheet';
            fonts.className = 'webfonts';
            // show hinted for Windows XP
            fonts.href      = guardian.config.stylesheets.fonts['hinting' + (shouldUseHintedFonts ? 'On' : 'Off') ].kerningOn;
            window.setTimeout(function() {
                thisScript.parentNode.insertBefore(fonts, thisScript);
            }, 0);
        }

        function loadFontsFromStorage() {
            var showFonts        = @if(FontSwitch.isSwitchedOn) {true} else {false},
                storedFontSwitch = localStorage['gu.prefs.switch.font-family'],
                storedFontFormat = localStorage['gu.fonts.format'];

            if (storedFontSwitch) {
                showFonts = JSON.parse(storedFontSwitch).value;
            }

            if (showFonts && storedFontFormat) {
                var fonts      = document.querySelectorAll('.webfont'),
                    fontFormat = JSON.parse(storedFontFormat).value

                for (var i = 0, j = fonts.length; i < j; ++i) {
                    var font            = fonts[i],
                        dataAttrName    = 'data-cache-file-' + (shouldUseHintedFonts ? 'hinted-' : '') + fontFormat,
                        nameAndCacheKey = font.getAttribute(dataAttrName).match(/fonts\/([^/]*?)\/?([^/]*)\.(woff2|woff|tff).json$/),
                        storedCachedCss = localStorage['gu.fonts.' + nameAndCacheKey[2] + '.' + nameAndCacheKey[1]];

                    if (storedCachedCss) {
                        font.innerHTML = JSON.parse(storedCachedCss).value;
                        font.setAttribute('data-cache-full', 'data-cache-full');
                    }
                }
            }
        }

        try {
            loadFontsFromStorage();
        } catch (e) {
            loadFontsAsynchronously();
        }

        @if(InlineCriticalCss.isSwitchedOn && !play.Play.isDev()) {
            function loadCssFromStorage() {
                var c = localStorage.getItem('gu.css.@Static("stylesheets/global.css").md5Key'), s, head;
                if(c) {
                    s = document.createElement('style');
                    head = document.getElementsByTagName('head')[0];
                    s.innerHTML = c;
                    s.setAttribute('data-loaded-from', 'local');
                    head.appendChild(s);
                    guardian.css.loaded = true;
                }
            }

            loadCssFromStorage();
        }

    })(guardian.isModernBrowser);

    @* inline curl *@
    @Html(Static.js.curl)

    require([
        'core',
        'domReady!'
    ], function() {

        require([
            'raven',
            'common/utils/config'
        ], function(
            raven,
            config
        ) {

            raven.config(
                'http://' + config.page.sentryPublicApiKey + '@@' + config.page.sentryHost,
                {
                    whitelistUrls: [
                        /assets\.guim\.co\.uk/,
                        /ophan\.co\.uk/
                    ],
                    tags: {
                        edition: config.page.edition,
                        contentType: config.page.contentType,
                        revisionNumber: config.page.revisionNumber
                    },
                    dataCallback: function(data) {
                        if (data.culprit) {
                            data.culprit = data.culprit.replace(/\/[a-z\d]{32}(\/[^\/]+)$/, '$1');
                        }
                        data.tags.origin = (/j.ophan.co.uk/.test(data.culprit)) ? 'ophan' : 'app';
                        return data;
                    },
                    shouldSendCallback: function(data) {
                        return Math.random() < 0.2 && guardian.config.switches.enableDiagnosticsLogging;
                    }
                }
            ).install();

            require([
                'common/modules/experiments/ab',
                'common/modules/ui/images'
            ], function(
                ab,
                images
            ) {

                ab.segmentUser();
                ab.run();
                images.upgrade();
                images.listen();

                if (config.switches.commercial) {
                    require(['bootstraps/commercial'], function(commercial) {
                        raven.context(
                            { tags: { feature: 'commercial' } },
                            commercial.init,
                            []
                        );
                    });
                }

                if (guardian.isModernBrowser) {
                    @if(play.Play.isDev()) {
                        require(['bootstraps/dev'], function (devmode) { devmode.init(); });
                    }

                    require(['bootstraps/app'], function(bootstrap) {
                        bootstrap.go();
                    });
                }

            });

        });

    });
</script>
