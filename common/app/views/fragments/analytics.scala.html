@(page: model.Page)( implicit request:RequestHeader)
@import conf.Configuration
@import common.AnalyticsHost
@import views.support.{OmnitureAnalyticsData, GoogleAnalyticsAccount}
@import conf.Static
@import conf.switches.Switches.NonBlockingOmniture
@import conf.switches.Switches.BritishCouncilBeacon
@import common.InlineJs

@if(NonBlockingOmniture.isSwitchedOn) {
    @fragments.omnitureScript(Some(page.metadata))

    <script>
        // analytics code
        @InlineJs(templates.inlineJS.blocking.js.analytics().body, "analytics.js")
    </script>
}

@defining(s"${request.host}${request.path}") { path =>

    @defining(
        s"${AnalyticsHost()}/b/ss/${Configuration.javascript.pageData("guardian.page.omnitureAccount")}/1/H.25.3/?${OmnitureAnalyticsData(page, "No Javascript", path)}"
    ){ omnitureCall =>
            <noscript id="omnitureNoScript">
                <div>
                    <img id="omnitureNoScriptImage" alt=""
                         src="@Html(omnitureCall)" width="1" height="1" class="u-h" />
                    <img id="omnitureConfidenceNoScriptImage" alt=""
                         src="@{Configuration.debug.beaconUrl}/count/pva.gif" width="1" height="1" class="u-h" />
                </div>
            </noscript>
    }

        <script>
            @*
                Basic Omniture runs on both Core & 'Full experience'
                We just need to run Ophan here.
            *@

            if (!guardian.isEnhanced) {
                var ophanScript = document.createElement('script'),
                        sc = document.getElementsByTagName('script')[0];

                ophanScript.src = '@Static("javascripts/bootstraps/enhanced/ophan.js")';
                ophanScript.async = true;
                sc.parentNode.insertBefore(ophanScript, sc);
            }
        </script>
}

@* google remarketing fallback *@
<noscript>
    <div style="display:inline;">
        <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/971225648/?value=0&amp;guid=ON&amp;script=0"/>
    </div>
</noscript>

<img src="@Configuration.debug.beaconUrl/count/pv.gif" alt="" style="display : none ;" rel="nofollow"/>

@if(GoogleAnalyticsAccount.shouldTrack(page)) {
    <script>

        @* e.g. for one in every 10 mpage views *@
        if (Math.floor(Math.random() * @GoogleAnalyticsAccount.sampleSize) === 0) {

            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', '@GoogleAnalyticsAccount.account', 'auto');
            ga('send', 'pageview');

        }

    </script>

    @*
        If at some point in the future this goes live, somebody think of "noscript" for Google Analytics
    *@
}

@if(BritishCouncilBeacon.isSwitchedOn && page.metadata.url.contains("british-council-partner-zone")) {
    <img alt="DCSIMG" id="DCSIMG" width="1" height="1"
    src="http://statse.webtrendslive.com/dcsozkqgb00000sh0y1unaabw_9e3r/njs.gif?dcssip=www.guardian.co.uk&amp;dcsuri=/british-council-partner-zone&amp;WT.dl=0&amp;WT.es=www.guardian.co.uk/british-council-partner-zone&amp;WT.sp=Guardian_British_Council_Zone&amp;WT.js=No&amp;WT.tv=BC.nojs.1"/>
}
