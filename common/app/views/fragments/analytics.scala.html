@(page: model.MetaData)( implicit request:RequestHeader)
@import org.joda.time.DateTime
@import conf.Configuration
@import conf.Switches.FreshnessLoggingSwitch

@*<!-- TODO temporary till after dotcom switch -->*@
@defining(
    if (Configuration.environment.secure) {
        "https://hits-secure.theguardian.com"
    } else {
        "http://hits.theguardian.com"
    }
){ analyticsHost =>

    @defining(request.host + request.path) { path =>

        @defining(
        (s"$analyticsHost/b/ss/${Configuration.javascript.pageData("guardian.page.omnitureAccount")}/1/H.25.3/?${OmnitureAnalyticsData(page, "No Javascript", path)}",
        Configuration.javascript.pageData("guardian.page.omnitureAccount"))
        ){ case (omnitureCall, omnitureAccount) =>
                <noscript id="omnitureNoScript">
                    <div>
                        <img id="omnitureNoScriptImage" alt=""
                             src="@Html(omnitureCall)" width="1" height="1" class="u-h" />
                    </div>
                </noscript>
        }

        @defining(
            s"$analyticsHost/b/ss/${Configuration.javascript.pageData("guardian.page.omnitureAccount")}/1/H.25.3/?${OmnitureAnalyticsData(page, "Partial Javascript", path)}"
        ){ omnitureCall =>
                <script>
                    @*
                    //    we do not run our javascript on some browsers, hence analytics will not run.
                    //    this does a minimal tracking for those devices
                     *@
                    if (!guardian.isModernBrowser) {
                        var analyticsImage = document.createElement("img");
                        analyticsImage.src = "@Html(omnitureCall)";
                        analyticsImage.width = "1";
                        analyticsImage.height = "1";
                        document.body.appendChild(analyticsImage);

                        @* there is currently no SSL version of the beacon *@
                        @if(!Configuration.environment.secure){
                            @*
                            // this is used to sanity check our analytics calls
                            *@
                            var img = new Image();
                            img.src = "@{Configuration.debug.beaconUrl}/count/pva.gif";

                            var s = document.createElement('script'),
                                    sc = document.getElementsByTagName('script')[0];

                            s.src = '@Static("javascripts/bootstraps/ophan.js")';
                            s.aysnc = true;
                            sc.parentNode.insertBefore(s, sc);
                        }
                    }
                </script>
        }
    }
}

@* there is currently no SSL version of the beacon *@
@if(!Configuration.environment.secure) {
    <img src="@Configuration.debug.beaconUrl/count/pv.gif" alt="" style="display : none ;" rel="nofollow"/>

    @if(FreshnessLoggingSwitch.isSwitchedOn) {
        @defining(DateTime.now) { now =>

            @if(Edition.isEditionFront(request)) {
                <img src="@Configuration.debug.beaconUrl/freshness/front/@{now.getMillis}" alt="" style="display : none ;" rel="nofollow"/>
            } else {
                <img src="@Configuration.debug.beaconUrl/freshness/@{now.getMillis}" alt="" style="display : none ;" rel="nofollow"/>
            }
            <!-- @now.toString() -->
        }
    }
}
