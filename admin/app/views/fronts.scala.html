@(env: String)

@admin_main("Fronts editor", env, isAuthed = true) {

    <div class="splash" data-bind="visible: false">Loading Fronts Editor...</div> 

    <div class="fronts" data-bind="visible: true" style="display: none">
        <header>
            <div class="tool-title">Trailblock Editor</div>
            <div class="list-picker">
                <span data-bind="with: $root.selectedBlock()">
                    <a href="#" data-bind="click: $root.displayAllEditions">View in all editions &raquo;</a>
                </span>

                <span class="list-picker__title">Find blocks:</span>

                <select data-bind="options: editions, optionsText: 'id', value: $root.selectedEdition, optionsCaption: 'Choose Edition...'"></select>

                <span data-bind="with: $root.selectedEdition()">
                    <select data-bind="options: sections, optionsText: 'id', value: $root.selectedSection, optionsCaption: 'Choose Section...'"></select>

                    <span data-bind="with: $root.selectedSection()">
                        <select data-bind="options: blocks, optionsText: 'id', value: $root.selectedBlock, optionsCaption: 'Choose Block...'"></select>
                    </span>

                </span>
            </div>
        </header>

        <div class="finder">
            <i class="icon-trash icon-white list-tool" data-bind="click: flushClipboard"></i>
            <div class="finder__title">Clipboard</div>
            <div id="clipboard" class="connectedList"></div>

            <i class="icon-refresh icon-white list-tool" data-bind="click: latestArticles.refresh"></i>
            <div class="finder__title">Search Articles</div>

            <input type="text" placeholder="url or keyword" data-bind='
                event: {keyup: latestArticles.search, afterpaste: latestArticles.search},
                value: latestArticles.term,
                valueUpdate: ["afterkeydown", "afterpaste"]'/>

            <input type="text" placeholder="section" data-bind='
                event: {keyup: latestArticles.search, afterpaste: latestArticles.search},
                value: latestArticles.section,
                valueUpdate: ["afterkeydown", "afterpaste"]'/>

            <div id="latest-articles" class="connectedList" data-bind="template: {name: 'template_article', foreach: latestArticles.articles()}">Searching...</div>
        </div>

        <div id="trailblocks" data-bind="foreach: listsDisplayed">
            <div class="trailblock">
                <div class="list-header">
                    <i class="icon-cog icon-white list-tool" data-bind="click: toggleEditingConfig"></i>

                    <a data-bind="click: $parent.dropList" class="list-header__hide" title="Hide this block">HIDE</a>
                    <div class="list-header__title" data-bind="foreach: crumbs">
                        <span class="list-header__title__part" data-bind="text: $data"></span> 
                    </div>
                    <div data-bind="visible: !state.editingConfig()">
                        <div class="list-header__meta">
                            <!-- ko if: state.timeAgo -->
                                updated <span class="list-header__meta__last-updated" data-bind="text: state.timeAgo"></span> 
                                by <a class="list-header__meta__user" data-bind="
                                    text: meta.updatedBy,
                                    attr: {href: 'mailto:' + meta.updatedEmail}
                                    "></a>
                            <!-- /ko -->
                            <!-- ko ifnot: state.timeAgo -->
                                Empty
                            <!-- /ko -->
                        </div>
                        <div class="list-header__status">
                            <div class="list-header__status__live" data-bind="
                                css: {
                                    active: state.liveMode()
                                }">
                                <span class="list-header__status__live__title" data-bind="click: setLiveMode">LIVE</span>
                            </div>                    
                            <div class="list-header__status__draft" data-bind="
                                css: {
                                    active: !state.liveMode(),
                                    hasUnPublishedEdits: state.hasUnPublishedEdits()
                                }">
                                <span class="list-header__status__draft__title" data-bind="click: setDraftMode">
                                    DRAFT
                                    <span data-bind="if: state.hasUnPublishedEdits()">
                                        has edits
                                    </span>
                                </span>
                                <span data-bind="if: !state.liveMode() && state.hasUnPublishedEdits()">
                                    &middot; <a class="list-header__status__control" data-bind="click: publishDraft">publish</a>
                                    &middot; <a class="list-header__status__control" data-bind="click: discardDraft">discard</a>
                                </span>
                            </div>                    
                        </div>                    
                    </div>                    
                </div>
                <div class="list-config" data-bind="visible: state.editingConfig">
                    <div>
                        Number of articles:
                    </div>
                    <div>
                        <input type="number" class="tiny" data-bind="value: config.min"/> Minumum
                    </div>
                    <div>
                        <input type="number" class="tiny" data-bind="value: config.max"/> Maximum
                    </div>
                    <div>ContentApi query for trail automation:</div>
                    <div>
                        <input type="text" data-bind="value: config.contentApiQuery"/>
                    </div>
                    <input type="submit" class="btn" value="Save" data-bind="click: saveConfig"/>
                    <button class="btn" value="Cancel" data-bind="click: stopEditingConfig">Cancel</button>
                </div>
                <div class="needs-more" data-bind="if: needsMore">
                    Needs at least <span class="needs-more__num" data-bind="text: config.min"></span> 
                    article<span data-bind="text: config.min() > 1 ? 's' : ''"></span>
                </div>
                <div class="connectedList persisted" data-bind="
                    attr: {
                        'data-list-id': id,
                        'data-live-edit': state.liveMode()
                    },
                    css: {pending: state.loadIsPending},
                    template: {name: 'template_article', foreach: state.liveMode() ? live : draft}"></div>
            </div>
        </div>
    </div>

    <script type="text/html" id="template_article">
        <div class="trail cf" data-bind="
                attr: {'data-url': meta.id},
                css: {redundant: $parent.config && $parent.config.max ? (0 + $index()) >= (0 + $parent.config.max()) : false}
            ">

            <div class="trail_tweaks cf" data-bind="visible: state.editingConfig">
                <div>
                    Headline override:
                    <input type="text" data-bind="value: config.webTitle"/>
                </div>
                <input type="submit" class="btn" value="Save" data-bind="click: $parent.saveItemConfig"/>
                <button class="btn" value="Cancel" data-bind="click: $parent.forceRefresh">Cancel</button>
            </div>

            <!-- ko if: (config.webTitle() && (meta.webTitle() !== config.webTitle())) -->
            <span class="webTitle webTitle--override" data-bind="text: config.webTitle"></span>
            <!-- /ko -->

            <a class="webTitle" data-bind="
            text: meta.webTitle, 
            attr: {href: 'http://www.theguardian.com/' + meta.id()}"></a>

            <img data-bind="attr: {src: fields.thumbnail}" />

            <div class="trail__meta">
                <span data-bind="html: humanDate() ? humanDate : 'Loading...'"></span>
                <a class="trail__meta__stats"  data-bind="attr: {href: 'http://dashboard.ophan.co.uk/summary?path=/' + meta.id()}">stats</a>
                <!--a class="trail__meta__tweak"  data-bind="click: toggleEditingConfig">tweak</a-->
                <a class="trail__meta__remove" data-bind="click: $parent.dropItem">remove</a>
            </div>

            <div class="trail_stats cf">
                <div class="pageviews" data-bind="if: pageViewsCommas(), text: pageViewsCommas"></div>
                <div class="pageviews-graph" data-bind="if: state.pageViewsSeries(), sparkline: state.pageViewsSeries"></div>
            </div>

        </div>
    </script>
    
    <script src="@routes.Assets.at("javascripts/fronts.js")"></script>
}
